<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CubeWell - 3D Puzzle Game</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ®</text></svg>">
</head>
<body>
    <div id="game-screen" class="screen">
        <div id="game-container">
            <div id="status-overlay" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-family: monospace; z-index: 100;">
                <div class="game-title">CubeWell</div>
                <div>Game State: <span id="game-running-status">?</span></div>
                <div>Score: <span id="score">0</span></div>
                <div>Level: <span id="level">1</span></div>
                <div>Last Key: <span id="last-key-pressed">None</span></div>
                <div>High Score: <span id="high-score">0</span></div>
                <div id="game-over-message" style="display: none; visibility: hidden;">
                    GAME OVER
                </div>
            </div>
            
            <!-- Add a centered start message that's separate from the status overlay -->
            <div id="start-message" style="display: none;">Press SPACE to Start</div>
            
            <div id="controls-overlay" style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-family: monospace; z-index: 100;">
                <div><strong>Controls:</strong></div>
                <div>Arrows: Move Block</div>
                <div>Q/E: Rotate X/Z axis</div>
                <div>W: Rotate Y axis</div>
                <div>Space: Drop Block</div>
                <div>P: Pause/Resume</div>
                <div>R: Restart Game</div>
                <div>M: Toggle Music</div>
            </div>
            
            <div id="canvas-container"></div>
            <div id="game-info">
                <div id="next-block">
                    <div id="next-block-label">Next:</div>
                    <div id="preview-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hidden elements for game functionality -->
    <div style="display: none;">
        <input type="range" id="music-volume" min="0" max="100" value="50">
        <input type="range" id="sfx-volume" min="0" max="100" value="50">
        <select id="difficulty">
            <option value="medium" selected>Medium</option>
        </select>
    </div>
    
    <!-- Load libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Polyfill for crypto.randomUUID -->
    <script>
    // Ensure crypto object exists on window
    if (!window.crypto) {
        window.crypto = {};
    }

    // Add randomUUID function if not present
    if (!window.crypto.randomUUID) {
        console.log("Adding polyfill for crypto.randomUUID");
        window.crypto.randomUUID = function() {
            // Fallback implementation for browsers that don't support randomUUID
            // This creates a UUID v4 compatible string
            
            // Use crypto.getRandomValues if available, otherwise Math.random
            let getRandomValues;
            if (window.crypto.getRandomValues) {
                getRandomValues = function(array) {
                    return window.crypto.getRandomValues(array);
                };
            } else {
                console.warn("crypto.getRandomValues not available, using Math.random fallback");
                getRandomValues = function(array) {
                    for (let i = 0; i < array.length; i++) {
                        array[i] = Math.floor(Math.random() * 256);
                    }
                    return array;
                };
            }

            // Generate a random UUID v4
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = getRandomValues(new Uint8Array(1))[0] % 16;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };
        
        // For backward compatibility, also attach to crypto directly if it exists
        if (typeof crypto !== 'undefined' && crypto !== window.crypto) {
            crypto.randomUUID = window.crypto.randomUUID;
        }
    }
    </script>

    <!-- Load game scripts -->
    <script type="module" src="js/main.js"></script>

    <!-- Diagnostic script to check for issues -->
    <script>
    // Wait a short time for initialization to complete
    setTimeout(function() {
        console.log("Running diagnostic check...");
        
        // Check if game was properly initialized
        if (!window.game || (typeof window.game.isRunning !== 'function')) {
            console.warn("Game failed to initialize properly");
            
            // Check the status display
            const statusEl = document.getElementById('game-running-status');
            if (statusEl) {
                statusEl.textContent = "ERROR - Reinitializing...";
                statusEl.style.color = "orange";
            }
            
            // Try to (re)initialize the game manually
            if (typeof window.initGame === 'function') {
                console.log("Attempting to reinitialize game...");
                window.initGame();
            } else {
                console.error("initGame function not available");
                
                // Update status to show error
                if (statusEl) {
                    statusEl.textContent = "ERROR - Refresh Page";
                    statusEl.style.color = "red";
                }
            }
        } else {
            console.log("Game initialized successfully", {
                running: window.game.isRunning(),
                paused: window.game.isPaused(),
                block: window.game.currentBlock ? "present" : "missing"
            });
            
            // Check if audio initialized
            if (window.AudioManager) {
                // Print audio status
                if (typeof window.AudioManager.debugStatus === 'function') {
                    console.log("Audio system status:", window.AudioManager.debugStatus());
                } else {
                    console.log("Audio system exists but status unknown");
                }
            } else {
                console.warn("Audio system not available globally");
            }
        }
    }, 2000);
    </script>

    <!-- Add a direct space key handler to start the game -->
    <script>
    document.addEventListener('keydown', function(event) {
        // If space key is pressed
        if (event.key === ' ' || event.code === 'Space') {
            console.log("Space key pressed directly on document");
            
            // Check if game exists
            if (window.game) {
                // Check if game is paused
                if (window.game.isPaused && window.game.isPaused()) {
                    console.log("Direct space handler: Game is paused, unpausing...");
                    
                    // Try to unpause the game
                    if (window.game.resume) {
                        window.game.resume();
                    } else if (window.game.unpause) {
                        window.game.unpause();
                    }
                    
                    // Hide the start message
                    const startMessage = document.getElementById('start-message');
                    if (startMessage) {
                        startMessage.style.display = 'none';
                    }
                    
                    // Update status display
                    const statusEl = document.getElementById('game-running-status');
                    if (statusEl) {
                        statusEl.textContent = "RUNNING";
                        statusEl.style.color = "lime";
                    }
                    
                    // Remove paused class from game screen
                    const gameScreen = document.getElementById('game-screen');
                    if (gameScreen) {
                        gameScreen.classList.remove('paused');
                    }
                }
            }
        }
    });
    </script>

    <style>
    /* Prominent start message styling */
    #start-message {
        font-size: 48px;
        font-weight: bold;
        color: #4CAF50;
        text-align: center;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        padding: 30px;
        border-radius: 15px;
        z-index: 1000;
        width: 80%;
        max-width: 600px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        text-shadow: 0 0 10px #fff;
        border: 3px solid #4CAF50;
    }

    /* Add a full-screen overlay when game is paused */
    #game-screen.paused::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 90;
    }
    </style>
</body>
</html> 